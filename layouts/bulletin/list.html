{{ define "main" }}
<div class="container">
  <div class="row">
    <div class="col-12">
      <h1 class="text-center">{{ .Title }}</h1>
      <div class="content">
        {{ .Content }}
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      {{ $now := now }}
      <!-- This filter now correctly uses .ExpiryDate -->
      {{ $activeJobs := where .Pages ".ExpiryDate" "ge" $now }}       
      
      {{ if not $activeJobs }}
        <p class="text-center mt-4">There are currently no active postings. Last updated: {{ now.Format "January 2, 2006 at 3:04 PM" }}.</p>
      {{ else }}
        <!-- Sort by ExpiryDate so jobs ending soonest are at the top -->
        {{ range $activeJobs.ByExpiryDate }}
          <div class="card mb-4 shadow-sm">
            <div class="card-body">
              <h4 class="card-title">{{ .Title }}</h4>
              <h6 class="card-subtitle mb-2 text-muted">{{ .Params.institution }} - {{ .Params.pi }}</h6>
              <div class="card-text">
                {{ .Content | markdownify }}
              </div>
              {{ with .Params.link }}
                <a href="{{ . }}" class="btn btn-primary mt-3" target="_blank" rel="noopener">More Information</a>
              {{ end }}
              <!-- This now correctly uses .ExpiryDate -->
              <p class="card-text mt-3"><small class="text-muted">Visible on the bulletin board until: {{ .ExpiryDate.Format "January 2, 2006" }}</small></p>
            </div>
          </div>
        {{ end }}
      {{ end }}
    </div>
  </div>
</div>
{{ end }}
